@page
@model NewsSite.Pages.PostModel
@{
    Layout = "~/Pages/Shared/_Layout.cshtml";
    ViewData["Title"] = "News Feed";
    ViewData["HeaderData"] = Model.HeaderData;
}

<div class="posts-container">
    <!-- Create New Post Section -->
    <div class="create-post-section" id="createPostSection">
        <div class="create-post-header">
            <h3>What's happening?</h3>
            <button id="toggleCreatePost" class="toggle-create-btn">✏️ New Post</button>
        </div>
        
        <form id="createPostForm" class="create-post-form" style="display: none;">
            <div class="post-input-area">
                <div class="post-avatar">
                    <div class="avatar-small">
                        @(Model.HeaderData?.user?.Name?.Substring(0, 1).ToUpper() ?? "U")
                    </div>
                </div>
                <div class="post-content-input">
                    <input type="text" id="postTitle" placeholder="Post title..." maxlength="100" required />
                    <textarea id="postContent" placeholder="What's the news today?" maxlength="500" required></textarea>
                    <input type="url" id="postImageUrl" placeholder="Image URL (optional)" />
                    <div class="source-fields">
                        <input type="url" id="postSourceUrl" placeholder="Source URL (optional)" />
                        <input type="text" id="postSourceName" placeholder="Source name (optional)" maxlength="100" />
                    </div>
                    <select id="postCategory" required>
                        <option value="">Select Category</option>
                        <option value="Politics">Politics</option>
                        <option value="Technology">Technology</option>
                        <option value="Sports">Sports</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Health">Health</option>
                    </select>
                </div>
            </div>
            <div class="post-actions-create">
                <div class="char-counter">
                    <span id="titleCounter">0/100</span> • <span id="contentCounter">0/500</span>
                </div>
                <div class="post-buttons">
                    <button type="button" id="cancelPost" class="btn btn-secondary">Cancel</button>
                    <button type="submit" id="submitPost" class="btn btn-primary">Post</button>
                </div>
            </div>
        </form>
    </div>

    <div class="posts-header">
        <h2>
            <span>News Feed</span>
            <div class="feed-controls">
                <button id="refreshBtn" class="refresh-btn" title="Refresh Feed">🔄</button>
            </div>
        </h2>
        
        <!-- Filter Tabs -->
        <div class="filter-tabs">
            <button class="filter-tab active" data-filter="all">All News</button>
            <button class="filter-tab" data-filter="following">Following</button>
            <button class="filter-tab" data-filter="trending">Trending</button>
            <button class="filter-tab" data-filter="saved">Saved</button>
            <button class="filter-tab" data-filter="live-news">🔴 Live News</button>
        </div>
        
        <!-- News API Controls (initially hidden) -->
        <div id="newsApiControls" class="news-api-controls" style="display: none;">
            <div class="news-controls-header">
                <h4>📡 Live News Feed</h4>
                <button id="syncNewsBtn" class="btn btn-success">
                    <span class="btn-icon">⬇️</span>
                    <span class="btn-text">Sync to Database</span>
                </button>
            </div>
            <div class="news-categories">
                <button class="category-btn active" data-category="general">General</button>
                <button class="category-btn" data-category="business">Business</button>
                <button class="category-btn" data-category="technology">Technology</button>
                <button class="category-btn" data-category="sports">Sports</button>
                <button class="category-btn" data-category="health">Health</button>
                <button class="category-btn" data-category="entertainment">Entertainment</button>
                <button class="category-btn" data-category="science">Science</button>
            </div>
            <div class="news-search">
                <input type="text" id="liveSearchInput" placeholder="Search live news..." />
                <button id="liveSearchBtn" class="btn btn-primary">Search</button>
            </div>
        </div>
    </div>
    
    <div id="posts" class="post-list">
        <!-- Posts will be dynamically loaded here -->
    </div>
    
    <div id="loading" class="loading-spinner" style="display: none;">
        <div class="spinner"></div>
        <p>Loading more posts...</p>
    </div>
    
    <div id="endOfFeed" class="end-of-feed" style="display: none;">
        <p>🎉 You've reached the end of your feed!</p>
        <button id="backToTop" class="back-to-top-btn">Back to Top</button>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container"></div>

@section Scripts {
    <script>
        let currentPage = 1;
        let isLoading = false;
        let currentFilter = 'all';
        let hasMorePosts = true;
        const postsContainer = document.getElementById('posts');
        const loadingSpinner = document.getElementById('loading');
        const endOfFeed = document.getElementById('endOfFeed');

        // Enhanced post loading with better error handling
        async function loadPosts(reset = false) {
            if (isLoading || (!hasMorePosts && !reset)) return;
            
            isLoading = true;
            loadingSpinner.style.display = 'block';
            endOfFeed.style.display = 'none';
            
            if (reset) {
                currentPage = 1;
                postsContainer.innerHTML = '';
                hasMorePosts = true;
            }
            
            try {
                const jwt = localStorage.getItem('jwtToken');
                const response = await fetch(`/api/Posts?page=${currentPage}&limit=10&filter=${currentFilter}`, {
                    method: "GET",
                    headers: {
                        "Authorization": jwt ? "Bearer " + jwt : "",
                        "Content-Type": "application/json"
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.posts && data.posts.length > 0) {
                        data.posts.forEach(post => {
                            const postElement = createPostElement(post);
                            postsContainer.appendChild(postElement);
                        });
                        currentPage++;
                        
                        // Check if we've reached the end
                        if (data.posts.length < 10 || currentPage > data.totalPages) {
                            hasMorePosts = false;
                            endOfFeed.style.display = 'block';
                        }
                    } else {
                        hasMorePosts = false;
                        endOfFeed.style.display = 'block';
                    }
                } else if (response.status === 401) {
                    showToast("Please log in to view posts", "error");
                    setTimeout(() => window.location.href = '/Login', 2000);
                } else {
                    showToast("Failed to load posts. Please try again.", "error");
                }
            } catch (error) {
                console.error("Error loading posts:", error);
                showToast("Network error. Please check your connection.", "error");
            } finally {
                isLoading = false;
                loadingSpinner.style.display = 'none';
            }
        }

        // Create enhanced post element
        function createPostElement(post) {
            const postBlock = document.createElement('div');
            postBlock.className = 'post-card';
            postBlock.innerHTML = `
                <div class="post-header">
                    <div class="post-user">
                        <div class="user-avatar">
                            ${post.user.username.charAt(0).toUpperCase()}
                        </div>
                        <div class="user-info">
                            <a href="/user/${post.user.userId || post.articleID}" class="username">${post.user.username}</a>
                            <span class="post-time">${formatTimeAgo(post.publishDate)}</span>
                        </div>
                    </div>
                    <div class="post-category">
                        <span class="category-badge">${post.category}</span>
                    </div>
                </div>
                
                ${post.imageURL ? `<img src="${post.imageURL}" alt="${post.title}" class="post-image" loading="lazy" />` : ''}
                
                <div class="post-content">
                    <h3>${post.title}</h3>
                    <p>${post.content}</p>
                </div>
                
                ${post.sourceURL ? `
                <div class="post-source">
                    <i class="fas fa-external-link-alt"></i>
                    <span>Source: <a href="${post.sourceURL}" target="_blank" rel="noopener">${post.sourceName || 'External Link'}</a></span>
                </div>
                ` : ''}
                
                <div class="post-footer">
                    <div class="post-stats">
                        <span class="stat-item">
                            <span class="stat-icon">👁️</span>
                            <span class="stat-count">${post.views || Math.floor(Math.random() * 1000)}</span>
                        </span>
                        <span class="stat-item">
                            <span class="stat-icon">❤️</span>
                            <span class="stat-count" id="likes-${post.articleID}">${post.likes || 0}</span>
                        </span>
                    </div>
                    
                    <div class="post-actions">
                        <button class="btn btn-success ${post.isLiked ? 'liked' : ''}" onclick="likePost(${post.articleID})" id="like-btn-${post.articleID}">
                            <span class="btn-icon">${post.isLiked ? '❤️' : '🤍'}</span>
                            <span class="btn-text">Like</span>
                        </button>
                        <button class="btn btn-primary" onclick="sharePost(${post.articleID})">
                            <span class="btn-icon">🔄</span>
                            <span class="btn-text">Share</span>
                        </button>
                        <button class="btn btn-secondary" onclick="savePost(${post.articleID})">
                            <span class="btn-icon">🔖</span>
                            <span class="btn-text">Save</span>
                        </button>
                        <button class="btn btn-danger" onclick="reportPost(${post.articleID})">
                            <span class="btn-icon">⚠️</span>
                            <span class="btn-text">Report</span>
                        </button>
                    </div>
                </div>
            `;
            
            // Add animation
            postBlock.classList.add('new-post');
            return postBlock;
        }

        // Enhanced like functionality
        async function likePost(articleId) {
            const btn = document.getElementById(`like-btn-${articleId}`);
            const likesCount = document.getElementById(`likes-${articleId}`);
            const isLiked = btn.classList.contains('liked');
            
            try {
                const response = await fetch(`/api/Posts/Like/${articleId}`, {
                    method: "POST",
                    headers: {
                        "Authorization": "Bearer " + localStorage.getItem('jwtToken'),
                        "Content-Type": "application/json"
                    }
                });

                if (response.ok) {
                    // Toggle like state
                    btn.classList.toggle('liked');
                    const icon = btn.querySelector('.btn-icon');
                    const currentCount = parseInt(likesCount.textContent);
                    
                    if (isLiked) {
                        icon.textContent = '🤍';
                        likesCount.textContent = currentCount - 1;
                        showToast("Post unliked", "info");
                    } else {
                        icon.textContent = '❤️';
                        likesCount.textContent = currentCount + 1;
                        showToast("Post liked!", "success");
                    }
                } else {
                    showToast("Failed to like post. Please try again.", "error");
                }
            } catch (error) {
                console.error("Error liking post:", error);
                showToast("Network error. Please try again.", "error");
            }
        }

        // Enhanced share functionality
        async function sharePost(articleId) {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Check out this news article',
                        url: window.location.href + `#post-${articleId}`
                    });
                    showToast("Post shared successfully!", "success");
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        copyToClipboard(window.location.href + `#post-${articleId}`);
                    }
                }
            } else {
                copyToClipboard(window.location.href + `#post-${articleId}`);
            }
        }

        // Save post functionality
        async function savePost(articleId) {
            try {
                const response = await fetch(`/api/Posts/Save/${articleId}`, {
                    method: "POST",
                    headers: {
                        "Authorization": "Bearer " + localStorage.getItem('jwtToken'),
                        "Content-Type": "application/json"
                    }
                });

                if (response.ok) {
                    showToast("Post saved to bookmarks!", "success");
                } else {
                    showToast("Failed to save post. Please try again.", "error");
                }
            } catch (error) {
                console.error("Error saving post:", error);
                showToast("Network error. Please try again.", "error");
            }
        }

        async function reportPost(articleId) {
            if (!confirm("Are you sure you want to report this post?")) return;
            
            try {
                const response = await fetch(`/api/Posts/Report/${articleId}`, {
                    method: "POST",
                    headers: {
                        "Authorization": "Bearer " + localStorage.getItem('jwtToken'),
                        "Content-Type": "application/json"
                    }
                });

                if (response.ok) {
                    showToast("Post reported successfully. Thank you for helping keep our community safe.", "success");
                } else {
                    showToast("Failed to report post. Please try again.", "error");
                }
            } catch (error) {
                console.error("Error reporting post:", error);
                showToast("Network error. Please try again.", "error");
            }
        }

        // Utility functions
        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h`;
            if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)}d`;
            
            return date.toLocaleDateString();
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast("Link copied to clipboard!", "success");
            }).catch(() => {
                showToast("Failed to copy link", "error");
            });
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            const toastContainer = document.querySelector('.toast-container') || createToastContainer();
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.className = 'toast-container';
            document.body.appendChild(container);
            return container;
        }

        // Filter functionality
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.dataset.filter;
                loadPosts(true);
            });
        });

        // Refresh functionality
        document.getElementById('refreshBtn').addEventListener('click', () => {
            loadPosts(true);
            showToast("Feed refreshed!", "success");
        });

        // Back to top functionality
        document.getElementById('backToTop').addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Enhanced infinite scrolling
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
                    loadPosts();
                }
            }, 100);
        });

        // Global function for category filtering
        window.filterPostsByCategory = function(category) {
            currentFilter = category.toLowerCase();
            loadPosts(true);
            showToast(`Showing ${category} posts`, "info");
        };

        // Category click handlers for left sidebar
        document.addEventListener('DOMContentLoaded', function() {
            // Mobile menu toggle functionality
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const leftSidebar = document.querySelector('.left-sidebar');
            
            if (mobileMenuToggle && leftSidebar) {
                mobileMenuToggle.addEventListener('click', function() {
                    leftSidebar.classList.toggle('open');
                });
                
                // Close menu when clicking outside
                document.addEventListener('click', function(event) {
                    if (!leftSidebar.contains(event.target) && !mobileMenuToggle.contains(event.target)) {
                        leftSidebar.classList.remove('open');
                    }
                });
            }
            
            const categoryItems = document.querySelectorAll('.category-item');
            categoryItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const category = this.dataset.category;
                    if (category) {
                        filterPostsByCategory(category);
                        
                        // Update active state
                        categoryItems.forEach(cat => cat.classList.remove('active'));
                        this.classList.add('active');
                    }
                });
            });

            // Create post functionality
            const toggleCreateBtn = document.getElementById('toggleCreatePost');
            const createPostForm = document.getElementById('createPostForm');
            const cancelPostBtn = document.getElementById('cancelPost');
            const postTitle = document.getElementById('postTitle');
            const postContent = document.getElementById('postContent');
            const titleCounter = document.getElementById('titleCounter');
            const contentCounter = document.getElementById('contentCounter');

            toggleCreateBtn.addEventListener('click', function() {
                createPostForm.style.display = createPostForm.style.display === 'none' ? 'block' : 'none';
                if (createPostForm.style.display === 'block') {
                    postTitle.focus();
                }
            });

            cancelPostBtn.addEventListener('click', function() {
                createPostForm.style.display = 'none';
                createPostForm.reset();
                updateCharCounters();
            });

            // Character counters
            function updateCharCounters() {
                titleCounter.textContent = `${postTitle.value.length}/100`;
                contentCounter.textContent = `${postContent.value.length}/500`;
            }

            postTitle.addEventListener('input', updateCharCounters);
            postContent.addEventListener('input', updateCharCounters);

            // Create post form submission
            createPostForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = {
                    title: postTitle.value.trim(),
                    content: postContent.value.trim(),
                    imageURL: document.getElementById('postImageUrl').value.trim(),
                    sourceURL: document.getElementById('postSourceUrl').value.trim(),
                    sourceName: document.getElementById('postSourceName').value.trim(),
                    category: document.getElementById('postCategory').value
                };

                if (!formData.title || !formData.content || !formData.category) {
                    showToast('Please fill in all required fields', 'error');
                    return;
                }

                try {
                    const response = await fetch('/api/Posts/Create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                        },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        showToast('Post created successfully!', 'success');
                        createPostForm.reset();
                        createPostForm.style.display = 'none';
                        updateCharCounters();
                        
                        // Refresh the feed to show the new post
                        loadPosts(true);
                    } else {
                        const errorData = await response.json();
                        showToast(errorData.message || 'Failed to create post', 'error');
                    }
                } catch (error) {
                    console.error('Error creating post:', error);
                    showToast('Network error occurred', 'error');
                }
            });

            // Initialize character counters
            updateCharCounters();

            // Initialize News API functionality
            initializeNewsApi();
        });

        // News API Functions
        function initializeNewsApi() {
            // Handle filter tab clicks
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    const filter = this.getAttribute('data-filter');
                    currentFilter = filter;
                    
                    // Show/hide News API controls
                    const newsApiControls = document.getElementById('newsApiControls');
                    if (filter === 'live-news') {
                        newsApiControls.style.display = 'block';
                        loadLiveNews('general'); // Default category
                    } else {
                        newsApiControls.style.display = 'none';
                        loadPosts(true); // Load regular posts
                    }
                });
            });

            // Handle category buttons
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const category = this.getAttribute('data-category');
                    loadLiveNews(category);
                });
            });

            // Handle sync news button
            document.getElementById('syncNewsBtn').addEventListener('click', syncNewsToDatabase);

            // Handle live search
            document.getElementById('liveSearchBtn').addEventListener('click', searchLiveNews);
            document.getElementById('liveSearchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchLiveNews();
                }
            });
        }

        // Load live news from News API (with conservative API usage)
        async function loadLiveNews(category = 'general') {
            isLoading = true;
            loadingSpinner.style.display = 'block';
            postsContainer.innerHTML = '';
            
            try {
                // First try to load cached articles from database
                let response = await fetch(`/api/Posts?page=1&limit=20&filter=${category}`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.posts && data.posts.length > 0) {
                        // Show cached articles first
                        data.posts.forEach(post => {
                            const postElement = createPostElement(post);
                            postsContainer.appendChild(postElement);
                        });
                        showToast(`Showing ${data.posts.length} cached articles from ${category}`, 'info');
                        
                        // Add a notice about live updates
                        const liveNotice = document.createElement('div');
                        liveNotice.className = 'live-notice';
                        liveNotice.innerHTML = `
                            <div class="notice-content">
                                <h4>📡 Fresh News Available</h4>
                                <p>Want the latest headlines? Click below to fetch fresh articles (uses API quota).</p>
                                <button class="btn btn-primary" onclick="fetchFreshNews('${category}')">
                                    <span class="btn-icon">🔄</span>
                                    <span class="btn-text">Get Fresh Headlines</span>
                                </button>
                            </div>
                        `;
                        postsContainer.insertBefore(liveNotice, postsContainer.firstChild);
                    } else {
                        // No cached articles, offer to fetch fresh ones
                        postsContainer.innerHTML = `
                            <div class="no-posts">
                                <h3>No cached articles for ${category}</h3>
                                <p>Would you like to fetch fresh headlines from NewsAPI?</p>
                                <button class="btn btn-primary" onclick="fetchFreshNews('${category}')">
                                    <span class="btn-icon">📡</span>
                                    <span class="btn-text">Fetch Fresh Headlines</span>
                                </button>
                            </div>
                        `;
                    }
                } else {
                    showToast('Failed to load cached news', 'error');
                }
            } catch (error) {
                console.error('Error loading cached news:', error);
                showToast('Network error loading news', 'error');
            } finally {
                isLoading = false;
                loadingSpinner.style.display = 'none';
            }
        }

        // Fetch fresh news from API (only when user explicitly requests it)
        async function fetchFreshNews(category = 'general') {
            isLoading = true;
            loadingSpinner.style.display = 'block';
            
            try {
                showToast('Fetching fresh headlines from NewsAPI...', 'info');
                const response = await fetch(`/api/Posts/live-headlines?category=${category}&country=us&pageSize=20`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.posts && data.posts.length > 0) {
                        // Clear existing content and show fresh articles
                        postsContainer.innerHTML = '';
                        data.posts.forEach(post => {
                            const postElement = createLivePostElement(post);
                            postsContainer.appendChild(postElement);
                        });
                        showToast(`Loaded ${data.posts.length} fresh articles from ${category}`, 'success');
                    } else {
                        showToast('No fresh articles available', 'info');
                    }
                } else {
                    showToast('Failed to fetch fresh news', 'error');
                }
            } catch (error) {
                console.error('Error fetching fresh news:', error);
                showToast('Network error fetching fresh news', 'error');
            } finally {
                isLoading = false;
                loadingSpinner.style.display = 'none';
            }
        }

        // Make fetchFreshNews available globally
        window.fetchFreshNews = fetchFreshNews;

        // Search live news
        async function searchLiveNews() {
            const query = document.getElementById('liveSearchInput').value.trim();
            if (!query) {
                showToast('Please enter a search term', 'error');
                return;
            }

            isLoading = true;
            loadingSpinner.style.display = 'block';
            postsContainer.innerHTML = '';
            
            try {
                const response = await fetch(`/api/Posts/search-live?query=${encodeURIComponent(query)}&pageSize=20`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.posts && data.posts.length > 0) {
                        data.posts.forEach(post => {
                            const postElement = createLivePostElement(post);
                            postsContainer.appendChild(postElement);
                        });
                        showToast(`Found ${data.posts.length} articles for "${query}"`, 'success');
                    } else {
                        postsContainer.innerHTML = `<div class="no-posts">No articles found for "${query}".</div>`;
                    }
                } else {
                    showToast('Failed to search live news', 'error');
                }
            } catch (error) {
                console.error('Error searching live news:', error);
                showToast('Network error searching news', 'error');
            } finally {
                isLoading = false;
                loadingSpinner.style.display = 'none';
            }
        }

        // Create live post element (similar to createPostElement but for News API articles)
        function createLivePostElement(post) {
            const postBlock = document.createElement('div');
            postBlock.className = 'post-card live-post';
            postBlock.innerHTML = `
                <div class="live-indicator">
                    <span class="live-badge">🔴 LIVE</span>
                    <span class="source-time">From ${post.sourceName} • ${formatTimeAgo(post.publishDate)}</span>
                </div>
                
                <div class="post-header">
                    <div class="post-user">
                        <div class="user-avatar newsbot-avatar">
                            🤖
                        </div>
                        <div class="user-info">
                            <span class="username">NewsBot</span>
                            <span class="post-time">Live from ${post.sourceName}</span>
                        </div>
                    </div>
                    <div class="post-category">
                        <span class="category-badge live">${post.category}</span>
                    </div>
                </div>
                
                ${post.imageURL ? `<img src="${post.imageURL}" alt="${post.title}" class="post-image" loading="lazy" />` : ''}
                
                <div class="post-content">
                    <h3>${post.title}</h3>
                    <p>${post.content}</p>
                </div>
                
                <div class="post-source">
                    <i class="fas fa-external-link-alt"></i>
                    <span>Read full article: <a href="${post.sourceURL}" target="_blank" rel="noopener">${post.sourceName}</a></span>
                </div>
                
                <div class="post-footer">
                    <div class="live-post-actions">
                        <button class="btn btn-primary" onclick="saveLiveArticle(${JSON.stringify(post).replace(/"/g, '&quot;')})">
                            <span class="btn-icon">💾</span>
                            <span class="btn-text">Save to Feed</span>
                        </button>
                        <button class="btn btn-secondary" onclick="shareLivePost('${post.sourceURL}', '${post.title.replace(/'/g, "\\'")}')">
                            <span class="btn-icon">🔄</span>
                            <span class="btn-text">Share</span>
                        </button>
                        <button class="btn btn-info" onclick="window.open('${post.sourceURL}', '_blank')">
                            <span class="btn-icon">📖</span>
                            <span class="btn-text">Read Full</span>
                        </button>
                    </div>
                </div>
            `;
            
            return postBlock;
        }

        // Save live article to database
        async function saveLiveArticle(article) {
            try {
                const response = await fetch('/api/Posts/save-live-article', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    },
                    body: JSON.stringify({
                        title: article.title,
                        content: article.content,
                        url: article.sourceURL,
                        urlToImage: article.imageURL,
                        publishedAt: article.publishDate,
                        source: {
                            name: article.sourceName
                        }
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showToast('Article saved to your feed!', 'success');
                } else if (response.status === 401) {
                    showToast('Please log in to save articles', 'error');
                } else {
                    showToast('Failed to save article', 'error');
                }
            } catch (error) {
                console.error('Error saving article:', error);
                showToast('Network error saving article', 'error');
            }
        }

        // Share live post
        function shareLivePost(url, title) {
            if (navigator.share) {
                navigator.share({
                    title: title,
                    url: url
                });
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(url).then(() => {
                    showToast('Link copied to clipboard!', 'success');
                }).catch(() => {
                    showToast('Failed to copy link', 'error');
                });
            }
        }

        // Sync news to database
        async function syncNewsToDatabase() {
            const syncBtn = document.getElementById('syncNewsBtn');
            const originalText = syncBtn.innerHTML;
            
            syncBtn.innerHTML = '<span class="btn-icon">⏳</span><span class="btn-text">Syncing...</span>';
            syncBtn.disabled = true;
            
            try {
                const response = await fetch('/api/Posts/sync-news', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    showToast(`Synced ${result.articlesAdded} new articles to database!`, 'success');
                } else if (response.status === 401) {
                    showToast('Please log in to sync news', 'error');
                } else {
                    showToast('Failed to sync news', 'error');
                }
            } catch (error) {
                console.error('Error syncing news:', error);
                showToast('Network error syncing news', 'error');
            } finally {
                syncBtn.innerHTML = originalText;
                syncBtn.disabled = false;
            }
        }

        // Initial load
        loadPosts();
    </script>

    <style>
        /* News API Specific Styles */
        .news-api-controls {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .news-controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .news-controls-header h4 {
            margin: 0;
            color: #495057;
        }

        .news-categories {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .category-btn {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            padding: 6px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .category-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .news-search {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .news-search input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .live-post {
            border-left: 4px solid #dc3545;
        }

        .live-indicator {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            padding: 8px 15px;
            margin: -20px -20px 15px -20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .live-badge {
            font-weight: bold;
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .source-time {
            opacity: 0.9;
        }

        .newsbot-avatar {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            font-size: 18px;
        }

        .category-badge.live {
            background: #dc3545;
            color: white;
        }

        .live-post-actions {
            display: flex;
            gap: 10px;
            padding-top: 10px;
            border-top: 1px solid #e1e5e9;
        }

        .live-post-actions .btn {
            font-size: 12px;
            padding: 6px 12px;
        }

        .no-posts {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
            font-style: italic;
        }

        /* Live notice styles */
        .live-notice {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .notice-content h4 {
            margin: 0 0 10px 0;
            font-size: 18px;
        }

        .notice-content p {
            margin: 0 0 15px 0;
            opacity: 0.9;
        }

        .live-notice .btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
        }

        .live-notice .btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
        }

        /* Responsive adjustments */
        @@media (max-width: 768px) {
            .news-controls-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .news-categories {
                justify-content: center;
            }

            .live-post-actions {
                flex-direction: column;
                gap: 8px;
            }

            .live-post-actions .btn {
                text-align: center;
            }
        }

        /* Animation for new live posts */
        @@keyframes slideInLive {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .live-post {
            animation: slideInLive 0.5s ease-out;
        }

        /* Filter tab indicator for live news */
        .filter-tab[data-filter="live-news"] {
            position: relative;
        }

        .filter-tab[data-filter="live-news"]::before {
            content: "";
            position: absolute;
            top: -2px;
            right: -2px;
            width: 8px;
            height: 8px;
            background: #dc3545;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @@keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
            }
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
            }
        }
    </style>
}
