<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NewsSitePro Architecture Explanation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            color: #333;
        }
        header {
            background: #6f42c1;
            color: #fff;
            padding: 1rem 0;
            text-align: center;
        }
        header h1 {
            margin: 0;
            font-size: 2rem;
        }
        main {
            padding: 2rem;
            max-width: 1000px;
            margin: 0 auto;
            background: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        section {
            margin-bottom: 2rem;
        }
        section h2 {
            color: #6f42c1;
            border-bottom: 2px solid #6f42c1;
            padding-bottom: 0.5rem;
        }
        section h3 {
            color: #495057;
            margin-top: 1.5rem;
        }
        code {
            background: #f4f4f9;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: Consolas, monospace;
            color: #d6336c;
        }
        pre {
            background: #f4f4f9;
            padding: 1rem;
            border-left: 4px solid #6f42c1;
            overflow-x: auto;
            font-family: Consolas, monospace;
            font-size: 0.9rem;
        }
        .highlight {
            background: #e7f3ff;
            padding: 0.5rem;
            border-left: 4px solid #6f42c1;
            margin: 1rem 0;
        }
        .flow-step {
            background: #f8f9fa;
            padding: 1rem;
            margin: 0.5rem 0;
            border-left: 4px solid #28a745;
            border-radius: 4px;
        }
        .flow-step strong {
            color: #28a745;
        }
        .file-reference {
            background: #fff3cd;
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-left: 4px solid #ffc107;
            font-family: Consolas, monospace;
            font-size: 0.9rem;
        }
        .architecture-layer {
            background: #e9ecef;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
            border-left: 4px solid #6f42c1;
        }
        footer {
            text-align: center;
            padding: 1rem 0;
            background: #6f42c1;
            color: #fff;
            margin-top: 2rem;
        }
        .benefits {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }
        .benefit-card {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <header>
        <h1>NewsSitePro Architecture Explanation</h1>
    </header>
    <main>
        <section>
            <h2>Overview</h2>
            <p>NewsSitePro follows a sophisticated <strong>multi-layered architecture</strong> that combines the flexibility of modern APIs with the power of server-side rendering. This document explains how the different layers work together to create a scalable, maintainable, and user-friendly news platform.</p>
            
            <div class="highlight">
                <strong>Key Concept:</strong> The system uses <em>context-driven rendering</em> where business logic determines what UI elements should be available, and views simply display what the context tells them to show.
            </div>
        </section>

        <section>
            <h2>Architecture Layers</h2>
            
            <div class="architecture-layer">
                <h3>1. Data Layer (Models & Database)</h3>
                <p><strong>Purpose:</strong> Stores and manages all application data</p>
                <div class="file-reference">üìÅ Key Files: DAL/DBservices.cs, Database2025/*.sql, BL/*.cs</div>
                <ul>
                    <li><strong>Database Services:</strong> Handles all database operations and stored procedures</li>
                    <li><strong>Business Logic:</strong> Contains domain models like <code>User</code>, <code>NewsArticle</code>, <code>Comment</code></li>
                    <li><strong>Stored Procedures:</strong> Optimized database queries with soft delete and blocking filters</li>
                </ul>
            </div>

            <div class="architecture-layer">
                <h3>2. Context Factory Layer (Business Logic)</h3>
                <p><strong>Purpose:</strong> The "brain" that decides what UI elements should be available</p>
                <div class="file-reference">üìÅ Key Files: Models/PostContextFactory.cs, Models/PostDisplayContext.cs</div>
                <ul>
                    <li><strong>PostContextFactory:</strong> Creates context objects based on user permissions and relationships</li>
                    <li><strong>PostDisplayContext:</strong> Contains all the flags like <code>CanEdit</code>, <code>CanDelete</code>, <code>ShowFollowButton</code></li>
                    <li><strong>Context Types:</strong> Feed, Profile, Individual, Admin, Compact</li>
                </ul>
                <pre>
// Example: Determining what a user can do with a post
public static PostDisplayContext CreateProfileContext(User? currentUser, NewsArticle post, int profileUserId)
{
    var context = new PostDisplayContext { /* ... */ };
    
    if (currentUser?.Id == profileUserId) {
        context.CanEdit = false;    // Disabled until implemented
        context.CanDelete = true;   // User can delete own posts
        context.ShowFollowButton = false; // Can't follow yourself
    }
    
    return context;
}</pre>
            </div>

            <div class="architecture-layer">
                <h3>3. Controller Layer (API Endpoints)</h3>
                <p><strong>Purpose:</strong> Handles HTTP requests and orchestrates data flow</p>
                <div class="file-reference">üìÅ Key Files: Controllers/NewsController.cs, Controllers/PostsController.cs</div>
                <ul>
                    <li><strong>Hybrid Endpoints:</strong> Accept API parameters but return rendered HTML</li>
                    <li><strong>Feed Routing:</strong> Different endpoints for different feed types (saved, following, trending)</li>
                    <li><strong>User Context:</strong> Loads current user and relationship data</li>
                </ul>
            </div>

            <div class="architecture-layer">
                <h3>4. View Layer (Rendering)</h3>
                <p><strong>Purpose:</strong> Renders HTML based on context decisions</p>
                <div class="file-reference">üìÅ Key Files: Views/Shared/_PostsList.cshtml, Views/Shared/Components/PostCard/Default.cshtml</div>
                <ul>
                    <li><strong>Partial Views:</strong> Reusable templates like <code>_PostsList.cshtml</code></li>
                    <li><strong>View Components:</strong> <code>PostCard</code> component renders individual posts</li>
                    <li><strong>Context-Driven:</strong> Views check context flags like <code>@if (context.CanDelete)</code></li>
                </ul>
            </div>

            <div class="architecture-layer">
                <h3>5. Client Layer (JavaScript & AJAX)</h3>
                <p><strong>Purpose:</strong> Handles dynamic loading and user interactions</p>
                <div class="file-reference">üìÅ Key Files: wwwroot/js/post-interactions.js, wwwroot/js/shared/*.js</div>
                <ul>
                    <li><strong>Dynamic Loading:</strong> AJAX calls to load more posts without page refresh</li>
                    <li><strong>Interactions:</strong> Like, save, delete, share functionality</li>
                    <li><strong>Feed Switching:</strong> Switch between All, Following, Saved feeds</li>
                </ul>
            </div>
        </section>

        <section>
            <h2>The Complete Request Flow</h2>
            <p>Here's exactly what happens when a user requests posts:</p>
            
            <div class="flow-step">
                <strong>Step 1: Initial Request</strong><br>
                JavaScript on frontend calls: <code>/api/News/posts/rendered?feed=saved&page=1</code>
            </div>
            
            <div class="flow-step">
                <strong>Step 2: Controller Processing</strong><br>
                <code>NewsController.GetPostsRendered()</code> determines the feed type and routes to appropriate method (e.g., <code>GetSavedPostsRendered()</code>)
            </div>
            
            <div class="flow-step">
                <strong>Step 3: User Context Loading</strong><br>
                Controller loads current user data and relationship information (follow status, block status)
            </div>
            
            <div class="flow-step">
                <strong>Step 4: Data Retrieval</strong><br>
                Controller calls <code>_newsService.GetSavedArticlesByUserAsync()</code> which uses database stored procedures with soft delete and block filters
            </div>
            
            <div class="flow-step">
                <strong>Step 5: Context Creation</strong><br>
                <code>PostContextFactory.CreateFeedContext()</code> analyzes user permissions and relationships to create context objects
            </div>
            
            <div class="flow-step">
                <strong>Step 6: View Model Assembly</strong><br>
                Controller creates <code>PostsListViewModel</code> containing posts, user data, and follow status maps
            </div>
            
            <div class="flow-step">
                <strong>Step 7: Template Rendering</strong><br>
                <code>return View("_PostsList", viewModel)</code> passes data to Razor partial view
            </div>
            
            <div class="flow-step">
                <strong>Step 8: Component Rendering</strong><br>
                <code>_PostsList.cshtml</code> loops through posts and calls <code>PostCard</code> component for each post with its specific context
            </div>
            
            <div class="flow-step">
                <strong>Step 9: HTML Generation</strong><br>
                Razor engine renders final HTML based on context flags: <code>@if (context.CanDelete)</code> determines if delete button appears
            </div>
            
            <div class="flow-step">
                <strong>Step 10: Response</strong><br>
                Fully rendered HTML is returned to JavaScript (not JSON!)
            </div>
            
            <div class="flow-step">
                <strong>Step 11: DOM Update</strong><br>
                JavaScript takes the HTML response and inserts it into the page DOM
            </div>
        </section>

        <section>
            <h2>Context-Driven Architecture Benefits</h2>
            
            <div class="benefits">
                <div class="benefit-card">
                    <h4>üéØ Centralized Business Logic</h4>
                    <p>All permission decisions are made in <code>PostContextFactory</code>, not scattered across multiple view files.</p>
                </div>
                
                <div class="benefit-card">
                    <h4>üîÑ Consistent UI Behavior</h4>
                    <p>The same context system works across all view types (feed, profile, individual, admin).</p>
                </div>
                
                <div class="benefit-card">
                    <h4>üõ°Ô∏è Security by Design</h4>
                    <p>Permissions are enforced server-side before any HTML is generated.</p>
                </div>
                
                <div class="benefit-card">
                    <h4>üß© Maintainable Code</h4>
                    <p>Changes to business rules only need to be made in one place - the context factory.</p>
                </div>
            </div>
        </section>

        <section>
            <h2>Multiple View Types Explained</h2>
            
            <h3>Why Different Contexts Exist</h3>
            <p>The system supports different contexts because posts are displayed in different scenarios:</p>
            
            <ul>
                <li><strong>Feed Context:</strong> Posts in main timeline - show follow buttons, full interactions</li>
                <li><strong>Profile Context:</strong> Posts on user's profile - hide follow button, show edit/delete for own posts</li>
                <li><strong>Individual Context:</strong> Single post view - show full content and comments</li>
                <li><strong>Admin Context:</strong> Admin panel - show moderation tools, minimal interactions</li>
                <li><strong>Compact Context:</strong> Sidebar widgets - minimal UI, no interactions</li>
            </ul>

            <h3>Template Reuse</h3>
            <p>Despite different contexts, the same templates are reused:</p>
            <div class="file-reference">Views/Shared/Components/PostCard/Default.cshtml - Used for ALL contexts</div>
            <div class="file-reference">Views/Shared/_PostsList.cshtml - Used for ALL list displays</div>
            
            <p>The templates adapt their output based on the context flags, ensuring consistency while allowing flexibility.</p>
        </section>

        <section>
            <h2>Hybrid API Architecture</h2>
            
            <div class="highlight">
                <strong>Unique Feature:</strong> NewsSitePro uses "Hybrid APIs" that accept REST parameters but return rendered HTML instead of JSON.
            </div>

            <h3>Traditional API vs. Hybrid API</h3>
            <pre>
// Traditional API Response (JSON):
{
  "posts": [
    {"id": 123, "title": "News Title", "content": "..."},
    {"id": 124, "title": "Another Title", "content": "..."}
  ],
  "currentUser": {"id": 1, "name": "John"},
  "pagination": {"page": 1, "hasMore": true}
}

// NewsSitePro Hybrid API Response (HTML):
&lt;div class="post-card" data-post-id="123"&gt;
    &lt;h3&gt;News Title&lt;/h3&gt;
    &lt;p&gt;News content...&lt;/p&gt;
    &lt;button class="delete-btn" onclick="deletePost(123)"&gt;Delete&lt;/button&gt;
&lt;/div&gt;
&lt;div class="post-card" data-post-id="124"&gt;
    &lt;!-- Another post --&gt;
&lt;/div&gt;</pre>

            <h3>Benefits of This Approach</h3>
            <ul>
                <li><strong>SEO Friendly:</strong> Search engines can read server-rendered content</li>
                <li><strong>Faster Loading:</strong> No client-side template compilation needed</li>
                <li><strong>Consistent Styling:</strong> All HTML generated with same Razor templates</li>
                <li><strong>Dynamic Updates:</strong> Easy to refresh specific sections via AJAX</li>
            </ul>
        </section>

        <section>
            <h2>Database Architecture</h2>
            
            <h3>Soft Delete Implementation</h3>
            <p>The system implements soft deletes to preserve data integrity:</p>
            
            <div class="file-reference">Database2025/delete_article_procedure.sql</div>
            <pre>
-- Instead of: DELETE FROM NewsArticles WHERE ArticleID = @ID
UPDATE NewsSitePro2025_NewsArticles 
SET IsDeleted = 1, DeletedAt = GETDATE()
WHERE ArticleID = @ArticleID AND IsDeleted = 0;</pre>

            <h3>Block Filter Integration</h3>
            <p>All post retrieval includes automatic filtering of blocked users:</p>
            
            <div class="file-reference">Database2025/user_blocking_system.sql</div>
            <pre>
-- Block filter in stored procedures:
AND (@CurrentUserID IS NULL OR na.UserID NOT IN (
    SELECT BlockedUserID FROM NewsSitePro2025_UserBlocks 
    WHERE BlockerUserID = @CurrentUserID AND IsActive = 1
))</pre>
        </section>

        <section>
            <h2>Error Handling & Fallbacks</h2>
            
            <p>The architecture includes multiple fallback mechanisms:</p>
            
            <h3>Database Layer Fallbacks</h3>
            <pre>
try {
    // Try stored procedure first
    SqlCommand cmd = CreateCommandWithStoredProcedureGeneral("SP_Name", con, paramDic);
    result = await cmd.ExecuteNonQueryAsync();
}
catch (Exception) {
    // Fall back to direct SQL if stored procedure doesn't exist
    string sql = "UPDATE NewsArticles SET IsDeleted = 1 WHERE ArticleID = @ID";
    SqlCommand cmd = new SqlCommand(sql, con);
    result = await cmd.ExecuteNonQueryAsync();
}</pre>

            <h3>Context Creation Fallbacks</h3>
            <ul>
                <li>If user data fails to load, system continues with guest context</li>
                <li>If follow status lookup fails, defaults to "not following"</li>
                <li>If context creation fails, falls back to basic display context</li>
            </ul>
        </section>

        <section>
            <h2>Performance Optimizations</h2>
            
            <h3>Batch Relationship Loading</h3>
            <p>Instead of querying follow status for each post individually, the system batches these queries:</p>
            
            <div class="file-reference">Controllers/NewsController.cs - LoadFollowStatusMapAsync()</div>
            <pre>
var uniqueUserIds = articles.Select(p => p.UserID).Distinct();
foreach (var userId in uniqueUserIds) {
    var isFollowing = await _userService.IsUserFollowingAsync(currentUserId, userId);
    followStatusMap[userId] = isFollowing;
}</pre>

            <h3>Context Caching</h3>
            <p>Context objects are lightweight and can be cached or reused for posts by the same user in the same request.</p>
        </section>

        <footer>
            <p>Created by the NewsSitePro Team | August 2025</p>
        </footer>
    </main>
</body>
</html>
