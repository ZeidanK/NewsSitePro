<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin API Testing</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-button { padding: 10px 20px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .test-button:hover { background-color: #0056b3; }
        .result { margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 4px; white-space: pre-wrap; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .error { background-color: #f8d7da; color: #721c24; }
        .success { background-color: #d4edda; color: #155724; }
        input, textarea, select { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .form-group { margin: 10px 0; }
        label { display: inline-block; width: 120px; font-weight: bold; }
        .info-section { background-color: #e7f3ff; padding: 15px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #0066cc; }
        .info-section h4 { margin-top: 0; color: #0066cc; }
        .info-section ol { margin: 10px 0; }
        .info-section li { margin: 5px 0; }
    </style>
</head>
<body>
    <h1>Admin API Testing Interface</h1>
    <p><strong>Note:</strong> Make sure you're logged in as an admin before testing these endpoints.</p>
    
    <div class="info-section" style="background-color: #e7f3ff; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
        <h4>üîç Troubleshooting Steps:</h4>
        <ol>
            <li><strong>First:</strong> Click "Test Connection" to verify API access and authentication</li>
            <li><strong>If getting JSON parse errors:</strong> Check browser's Network tab in DevTools to see actual response</li>
            <li><strong>If getting 403/401 errors:</strong> Make sure you're logged in as an admin user</li>
            <li><strong>If getting 404 errors:</strong> Make sure the application is running and API routes are registered</li>
        </ol>
        <p><strong>Expected response for Test Connection:</strong> Should show your user ID, username, and admin status</p>
    </div>

    <!-- Test Connection -->
    <div class="test-section">
        <h3>üîß Test API Connection</h3>
        <p>Test if the API is accessible and you're authenticated properly.</p>
        <button class="test-button" onclick="testConnection()">Test Connection</button>
        <div id="connectionResult" class="result"></div>
    </div>

    <!-- Dashboard Stats -->
    <div class="test-section">
        <h3>Dashboard Stats</h3>
        <button class="test-button" onclick="testDashboardStats()">Get Dashboard Stats</button>
        <div id="dashboardResult" class="result"></div>
    </div>

    <!-- Get Users -->
    <div class="test-section">
        <h3>Get Users</h3>
        <div class="form-group">
            <label>Page:</label>
            <input type="number" id="usersPage" value="1" min="1">
            <label>Page Size:</label>
            <input type="number" id="usersPageSize" value="10" min="1" max="100">
        </div>
        <div class="form-group">
            <label>Search:</label>
            <input type="text" id="usersSearch" placeholder="Search by name or email">
            <label>Status:</label>
            <select id="usersStatus">
                <option value="">All</option>
                <option value="active">Active</option>
                <option value="banned">Banned</option>
                <option value="inactive">Inactive</option>
            </select>
        </div>
        <button class="test-button" onclick="testGetUsers()">Get Users</button>
        <div id="usersResult" class="result"></div>
    </div>

    <!-- User Details -->
    <div class="test-section">
        <h3>Get User Details</h3>
        <div class="form-group">
            <label>User ID:</label>
            <input type="number" id="userDetailsId" value="1" min="1">
        </div>
        <button class="test-button" onclick="testGetUserDetails()">Get User Details</button>
        <div id="userDetailsResult" class="result"></div>
    </div>

    <!-- Ban User -->
    <div class="test-section">
        <h3>Ban User</h3>
        <div class="form-group">
            <label>User ID:</label>
            <input type="number" id="banUserId" value="1" min="1">
            <label>Reason:</label>
            <input type="text" id="banReason" placeholder="Reason for ban" required>
        </div>
        <div class="form-group">
            <label>Duration (days):</label>
            <input type="number" id="banDuration" value="1" min="1">
        </div>
        <button class="test-button" onclick="testBanUser()">Ban User</button>
        <div id="banResult" class="result"></div>
    </div>

    <!-- Unban User -->
    <div class="test-section">
        <h3>Unban User</h3>
        <div class="form-group">
            <label>User ID:</label>
            <input type="number" id="unbanUserId" value="1" min="1">
        </div>
        <button class="test-button" onclick="testUnbanUser()">Unban User</button>
        <div id="unbanResult" class="result"></div>
    </div>

    <!-- Activity Logs -->
    <div class="test-section">
        <h3>Activity Logs</h3>
        <div class="form-group">
            <label>Page:</label>
            <input type="number" id="logsPage" value="1" min="1">
            <label>Page Size:</label>
            <input type="number" id="logsPageSize" value="20" min="1" max="100">
        </div>
        <button class="test-button" onclick="testGetActivityLogs()">Get Activity Logs</button>
        <button class="test-button" onclick="testGetRecentActivityLogs()">Get Recent Logs (10)</button>
        <div id="logsResult" class="result"></div>
    </div>

    <!-- Reports -->
    <div class="test-section">
        <h3>Reports</h3>
        <button class="test-button" onclick="testGetAllReports()">Get All Reports</button>
        <button class="test-button" onclick="testGetPendingReports()">Get Pending Reports</button>
        <div id="reportsResult" class="result"></div>
    </div>

    <!-- Resolve Report -->
    <div class="test-section">
        <h3>Resolve Report</h3>
        <div class="form-group">
            <label>Report ID:</label>
            <input type="number" id="resolveReportId" value="1" min="1">
            <label>Action:</label>
            <select id="resolveAction">
                <option value="Resolved">Resolved</option>
                <option value="Dismissed">Dismissed</option>
                <option value="Warning Issued">Warning Issued</option>
                <option value="Content Removed">Content Removed</option>
            </select>
        </div>
        <div class="form-group">
            <label>Notes:</label>
            <textarea id="resolveNotes" placeholder="Resolution notes"></textarea>
        </div>
        <button class="test-button" onclick="testResolveReport()">Resolve Report</button>
        <div id="resolveResult" class="result"></div>
    </div>

    <script>
        const API_BASE = '/api/admin';

        // Helper function to make API calls
        async function makeApiCall(endpoint, method = 'GET', body = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include' // Include cookies for JWT
                };

                if (body) {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(`${API_BASE}${endpoint}`, options);
                
                // Check if response is ok first
                if (!response.ok) {
                    // Try to get error message from response
                    let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                    } catch {
                        // If JSON parsing fails, use the default message
                    }
                    
                    return {
                        success: false,
                        status: response.status,
                        data: { message: errorMessage }
                    };
                }

                // Get response text first to see what we're getting
                const responseText = await response.text();
                
                // Try to parse as JSON
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('Response text that failed to parse:', responseText);
                    return {
                        success: false,
                        status: response.status,
                        data: { 
                            message: `Failed to parse JSON response. Got: ${responseText.substring(0, 200)}...`,
                            parseError: parseError.message
                        }
                    };
                }
                
                return {
                    success: response.ok,
                    status: response.status,
                    data: data
                };
            } catch (error) {
                console.error('Network error:', error);
                return {
                    success: false,
                    status: 0,
                    data: { message: `Network error: ${error.message}` }
                };
            }
        }

        // Helper function to display results
        function displayResult(elementId, result) {
            const element = document.getElementById(elementId);
            element.className = `result ${result.success ? 'success' : 'error'}`;
            element.textContent = JSON.stringify(result, null, 2);
        }

        // Test functions
        async function testConnection() {
            const result = await makeApiCall('/test');
            displayResult('connectionResult', result);
        }

        async function testDashboardStats() {
            const result = await makeApiCall('/dashboard-stats');
            displayResult('dashboardResult', result);
        }

        async function testGetUsers() {
            const page = document.getElementById('usersPage').value;
            const pageSize = document.getElementById('usersPageSize').value;
            const search = document.getElementById('usersSearch').value;
            const status = document.getElementById('usersStatus').value;
            
            const params = new URLSearchParams({
                page: page,
                pageSize: pageSize,
                search: search,
                status: status
            });
            
            const result = await makeApiCall(`/users?${params.toString()}`);
            displayResult('usersResult', result);
        }

        async function testGetUserDetails() {
            const userId = document.getElementById('userDetailsId').value;
            const result = await makeApiCall(`/users/${userId}`);
            displayResult('userDetailsResult', result);
        }

        async function testBanUser() {
            const userId = document.getElementById('banUserId').value;
            const reason = document.getElementById('banReason').value;
            const duration = parseInt(document.getElementById('banDuration').value);
            
            if (!reason.trim()) {
                alert('Please enter a reason for the ban');
                return;
            }
            
            const result = await makeApiCall(`/users/${userId}/ban`, 'POST', {
                reason: reason,
                duration: duration
            });
            displayResult('banResult', result);
        }

        async function testUnbanUser() {
            const userId = document.getElementById('unbanUserId').value;
            const result = await makeApiCall(`/users/${userId}/unban`, 'POST');
            displayResult('unbanResult', result);
        }

        async function testGetActivityLogs() {
            const page = document.getElementById('logsPage').value;
            const pageSize = document.getElementById('logsPageSize').value;
            
            const params = new URLSearchParams({
                page: page,
                pageSize: pageSize
            });
            
            const result = await makeApiCall(`/activity-logs?${params.toString()}`);
            displayResult('logsResult', result);
        }

        async function testGetRecentActivityLogs() {
            const result = await makeApiCall('/activity-logs/recent?count=10');
            displayResult('logsResult', result);
        }

        async function testGetAllReports() {
            const result = await makeApiCall('/reports');
            displayResult('reportsResult', result);
        }

        async function testGetPendingReports() {
            const result = await makeApiCall('/reports?pendingOnly=true');
            displayResult('reportsResult', result);
        }

        async function testResolveReport() {
            const reportId = document.getElementById('resolveReportId').value;
            const action = document.getElementById('resolveAction').value;
            const notes = document.getElementById('resolveNotes').value;
            
            const result = await makeApiCall(`/reports/${reportId}/resolve`, 'POST', {
                action: action,
                notes: notes
            });
            displayResult('resolveResult', result);
        }
    </script>
</body>
</html>
