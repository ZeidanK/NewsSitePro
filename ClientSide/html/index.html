<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Home Page</title>
  <link rel="stylesheet" href="../CSS/Styles.css">
</head>
<body>

  <div class="general-container">
    <h2>Your News</h2>

    <div class="tags" id="tagsContainer"></div>

    <div class="tags" id="feedTabs">
      <button id="followingBtn" onclick="showShared()" style="display: none;">Following</button>
      <button onclick="showTrending()">Trending</button>
      <button id="savedBtn" onclick="showSaved()" style="display: none;">Saved</button>
    </div>

    <div id="newsContainer">Loading...</div>
  </div>

  <script>
    let allPosts = [];
    let selectedTags = new Set();
    let currentFeed = "all"; // Track current feed type

    // Check if user is logged in and show/hide appropriate buttons
    function checkAuthAndUpdateUI() {
      const jwt = localStorage.getItem('jwtToken');
      const isLoggedIn = jwt && jwt.trim() !== '';
      
      // Show/hide following button based on authentication
      const followingBtn = document.getElementById('followingBtn');
      if (followingBtn) {
        followingBtn.style.display = isLoggedIn ? 'inline-block' : 'none';
      }
      
      // Show/hide saved button based on authentication
      const savedBtn = document.getElementById('savedBtn');
      if (savedBtn) {
        savedBtn.style.display = isLoggedIn ? 'inline-block' : 'none';
      }
      
      return isLoggedIn;
    }

    async function loadTags() {
      try {
        const jwt = localStorage.getItem('jwtToken');
        const response = await fetch('/api/tags', {
          headers: { 'Authorization': 'Bearer ' + jwt }
        });

        const tags = await response.json();
        const container = document.getElementById('tagsContainer');
        container.innerHTML = '';

        const allBtn = document.createElement('button');
        allBtn.textContent = 'All';
        allBtn.onclick = () => {
          selectedTags.clear();
          currentFeed = "all";
          displayPosts("All");
          updateButtonStyles();
        };
        container.appendChild(allBtn);

        tags.forEach(tag => {
          const btn = document.createElement('button');
          btn.textContent = tag;
          btn.dataset.tag = tag;
          btn.onclick = () => toggleTag(tag);
          container.appendChild(btn);
        });
      } catch (error) {
        console.error('Failed to load tags:', error);
      }
    }

    function toggleTag(tag) {
      if (selectedTags.has(tag)) {
        selectedTags.delete(tag);
      } else {
        selectedTags.add(tag);
      }
      currentFeed = "filtered";
      displayPosts([...selectedTags]);
      updateButtonStyles();
    }

    function updateButtonStyles() {
      const buttons = document.querySelectorAll('#tagsContainer button');
      buttons.forEach(btn => {
        const tag = btn.textContent;
        if (tag === 'All') {
          btn.classList.toggle('active', selectedTags.size === 0 && currentFeed === "all");
        } else {
          btn.classList.toggle('active', selectedTags.has(tag));
        }
      });

      // Update feed tab styles
      const feedButtons = document.querySelectorAll('#feedTabs button');
      feedButtons.forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Highlight active feed button
      if (currentFeed === "following") {
        document.querySelector('#feedTabs button[onclick="showShared()"]')?.classList.add('active');
      } else if (currentFeed === "trending") {
        document.querySelector('#feedTabs button[onclick="showTrending()"]')?.classList.add('active');
      } else if (currentFeed === "saved") {
        document.querySelector('#feedTabs button[onclick="showSaved()"]')?.classList.add('active');
      }
    }

    async function fetchNews() {
      try {
        const jwt = localStorage.getItem('jwtToken');
        const headers = {};
        if (jwt) {
          headers['Authorization'] = 'Bearer ' + jwt;
        }
        
        const response = await fetch('/api/posts', {
          headers: headers
        });
        allPosts = await response.json();
        displayPosts("All");
      } catch (err) {
        console.error("Failed to load posts", err);
      }
    }

    function displayPosts(posts) {
      const container = document.getElementById("newsContainer");

      // If posts is a string like "All" or an array of tags, filter allPosts
      if (typeof posts === "string" || Array.isArray(posts) && posts.every(p => typeof p === "string")) {
        let filtered = [];
        if (posts === "All" || posts.length === 0) {
          filtered = allPosts;
        } else {
          const tags = Array.isArray(posts) ? posts : [posts];
          filtered = allPosts.filter(post => tags.includes(post.Category));
        }
        
        container.innerHTML = filtered.map(post => `
          <div class="post">
            <h3>${post.Title}</h3>
            <p>${post.Content}</p>
            <small>Category: ${post.Category}</small>
          </div>
        `).join("");
      } else {
        // If posts is an actual array of post objects, display them directly
        container.innerHTML = posts.map(post => `
          <div class="post">
            <h3>${post.Title}</h3>
            <p>${post.Content}</p>
            <small>Category: ${post.Category}</small>
            ${post.Username ? `<small>By: ${post.Username}</small>` : ''}
          </div>
        `).join("");
      }
    }

    async function showShared() {
      try {
        const jwt = localStorage.getItem('jwtToken');
        if (!jwt) {
          alert("Please log in to view posts from users you follow");
          return;
        }
        
        currentFeed = "following";
        const res = await fetch('/api/shared', {
          headers: { 'Authorization': 'Bearer ' + jwt }
        });
        const sharedPosts = await res.json();
        displayPosts(sharedPosts); // Pass the actual posts array
        updateButtonStyles();
      } catch (e) {
        alert("Failed to load shared posts");
      }
    }

    async function showTrending() {
      try {
        currentFeed = "trending";
        
        // Use the news posts/rendered endpoint with trending feed
        const response = await fetch('/api/news/posts/rendered?page=1&limit=10&feed=trending');
        if (response.ok) {
          const html = await response.text();
          document.getElementById("newsContainer").innerHTML = html;
        } else {
          // Fallback to API endpoint if rendered endpoint fails
          const fallbackResponse = await fetch('/api/trending');
          const trendingTopics = await fallbackResponse.json();
          
          // Display trending topics in a simple format
          const container = document.getElementById("newsContainer");
          container.innerHTML = trendingTopics.Topics.map(topic => `
            <div class="post trending-topic">
              <h3>${topic.Topic}</h3>
              <p>Category: ${topic.Category}</p>
              <small>Trend Score: ${topic.TrendScore.toFixed(1)} | ${topic.TotalInteractions} interactions</small>
            </div>
          `).join("");
        }
        updateButtonStyles();
      } catch (e) {
        console.error("Failed to load trending content:", e);
        alert("Failed to load trending content");
      }
    }

    async function showSaved() {
      try {
        const jwt = localStorage.getItem('jwtToken');
        if (!jwt) {
          alert("Please log in to view your saved posts");
          return;
        }
        
        currentFeed = "saved";
        const res = await fetch('/api/saved', {
          headers: { 'Authorization': 'Bearer ' + jwt }
        });
        const savedPosts = await res.json();
        displayPosts(savedPosts); // Pass the actual posts array
        updateButtonStyles();
      } catch (e) {
        alert("Failed to load saved posts");
      }
    }

    // Initialize
    checkAuthAndUpdateUI();
    loadTags();
    fetchNews();
  </script>

</body>
</html>
